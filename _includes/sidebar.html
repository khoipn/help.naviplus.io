{% assign current_page_url = page.url | remove: 'index.html' | replace: '//', '/' %}
{% if current_page_url != '/' and current_page_url contains '/' and current_page_url | slice: -1 == '/' %}
  {% assign current_page_url = current_page_url | remove_last: '/' %}
{% endif %}
{% if current_page_url == "" %}{% assign current_page_url = "/" %}{% endif %}

<!-- Favorites Section (at the top) -->
<h6 class="sidebar-heading favorites-heading d-none d-flex justify-content-between align-items-center px-3 text-muted" style="margin-top: 0.5rem; margin-bottom: 0.25rem;">FAVORITES</h6>
<ul class="nav flex-column d-none" id="favoritesList" style="margin-bottom: 0.5rem;">
  <!-- Favorites will be rendered here by JavaScript -->
</ul>
<div class="favorites-separator d-none" style="height: 8px; background-color: #e9ecef; margin: 0 0 1rem 0;"></div>

<!-- Main Navigation -->
<ul class="nav flex-column">
  <!-- Home Link -->
  <li class="nav-item">
    <a class="nav-link{% if current_page_url == '/' %} active{% endif %}" href="{{ site.baseurl | relative_url }}/">
      <span class="d-flex align-items-start sidebar-link-container">
        <i class="ri-home-4-line" style="margin-right: 8px; font-size: 1.1em; color: #0366d6;"></i>
        <span class="sidebar-title-text flex-grow-1">Home</span>
      </span>
    </a>
  </li>
  
  {% for item in site.data.navigation %}
    {% assign item_url_normalized = item.url | remove: 'index.html' | replace: '//', '/' %}
    {% if item_url_normalized != '/' and item_url_normalized contains '/' and item_url_normalized | slice: -1 == '/' %}
      {% assign item_url_normalized = item_url_normalized | remove_last: '/' %}
    {% endif %}
    {% if item_url_normalized == "" %}{% assign item_url_normalized = "/" %}{% endif %}

        
    {% assign item_is_active_parent = false %}
    {% if current_page_url contains item_url_normalized and current_page_url != item_url_normalized %}
      {% assign item_is_active_parent = true %}
    {% endif %}

    <li class="nav-item{% if item.title == 'line' %} sidebar-separator-line{% endif %}">
      {% if item.title == 'line' %}
        <!-- Render a separator line -->
        <div class="sidebar-separator-content"></div>
      {% elsif item.children %}
        <a class="nav-link{% if current_page_url == item_url_normalized %} active{% endif %}" data-bs-toggle="collapse" href="#collapse-{{ forloop.index }}" role="button" aria-expanded="{% if item_is_active_parent or current_page_url == item_url_normalized %}true{% else %}false{% endif %}" aria-controls="collapse-{{ forloop.index }}">
          <span class="d-flex align-items-start sidebar-link-container">
            <i class="ri-folder-line sidebar-folder-icon-closed{% if item_is_active_parent or current_page_url == item_url_normalized %} d-none{% endif %}"></i>
            <i class="ri-folder-open-line sidebar-folder-icon-open{% unless item_is_active_parent or current_page_url == item_url_normalized %} d-none{% endunless %}"></i>
            <span class="sidebar-title-text flex-grow-1">{{ item.title }}</span>
          </span>
        </a>
        <div class="collapse {% if item_is_active_parent or current_page_url == item_url_normalized %}show{% endif %}" id="collapse-{{ forloop.index }}">
          <ul class="nav flex-column ps-3 sidebar-children-list">
            {% for child in item.children %}
              {% assign child_url_normalized = child.url | remove: 'index.html' | replace: '//', '/' %}
              {% if child_url_normalized != '/' and child_url_normalized contains '/' and child_url_normalized | slice: -1 == '/' %}
                {% assign child_url_normalized = child_url_normalized | remove_last: '/' %}
              {% endif %}
              {% if child_url_normalized == "" %}{% assign child_url_normalized = "/" %}{% endif %}

              <!-- DEBUG: child.url: {{ child.url }}, child_url_normalized: {{ child_url_normalized }} -->

              <li class="nav-item sidebar-tree-item{% if child.title == 'line' %} sidebar-separator-line{% endif %}">
                {% if child.title == 'line' %}
                  <div class="sidebar-separator-content"></div>
                {% elsif child.children %}
                  <a class="nav-link{% if current_page_url == child_url_normalized %} active{% endif %}" data-bs-toggle="collapse" href="#collapse-{{ forloop.parentloop.index }}-{{ forloop.index }}" role="button" aria-expanded="{% if child_is_active_parent or current_page_url == child_url_normalized %}true{% else %}false{% endif %}" aria-controls="collapse-{{ forloop.parentloop.index }}-{{ forloop.index }}">
                    <span class="d-flex align-items-start sidebar-link-container">
                      <i class="ri-folder-line sidebar-folder-icon-closed{% if child_is_active_parent or current_page_url == child_url_normalized %} d-none{% endif %}"></i>
                      <i class="ri-folder-open-line sidebar-folder-icon-open{% unless child_is_active_parent or current_page_url == child_url_normalized %} d-none{% endunless %}"></i>
                      <span class="sidebar-title-text flex-grow-1">{{ child.title }}</span>
                    </span>
                  </a>
                  <div class="collapse {% if child_is_active_parent or current_page_url == child_url_normalized %}show{% endif %}" id="collapse-{{ forloop.parentloop.index }}-{{ forloop.index }}">
                    <ul class="nav flex-column ps-3 sidebar-children-list">
                      {% for grand_child in child.children %}
                        {% assign grand_child_url_normalized = grand_child.url | remove: 'index.html' | replace: '//', '/' %}
                        {% if grand_child_url_normalized != '/' and grand_child_url_normalized contains '/' and grand_child_url_normalized | slice: -1 == '/' %}
                          {% assign grand_child_url_normalized = grand_child_url_normalized | remove_last: '/' %}
                        {% endif %}
                        {% if grand_child_url_normalized == "" %}{% assign grand_child_url_normalized = "/" %}{% endif %}

                        <!-- DEBUG: grand_child.url: {{ grand_child.url }}, grand_child_url_normalized: {{ grand_child_url_normalized }} -->

                        <li class="nav-item sidebar-tree-item{% if grand_child.title == 'line' %} sidebar-separator-line{% endif %}">
                          {% if grand_child.title == 'line' %}
                            <div class="sidebar-separator-content"></div>
                          {% else %}
                            <a class="nav-link{% if current_page_url == grand_child_url_normalized %} active{% endif %}" href="{{ grand_child.url | relative_url }}"><span class="sidebar-title-text flex-grow-1">{{ grand_child.title }}</span></a>
                          {% endif %}
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% else %}
                  <a class="nav-link{% if current_page_url == child_url_normalized %} active{% endif %}" href="{{ child.url | relative_url }}"><span class="sidebar-title-text flex-grow-1">{{ child.title }}</span></a>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% else %}
        <a class="nav-link{% if current_page_url == item_url_normalized %} active{% endif %}" href="{{ item.url | relative_url }}"><span class="sidebar-title-text flex-grow-1">{{ item.title }}</span></a>
      {% endif %}
    </li>
  {% endfor %}
</ul>
